<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ArtPlayer Stream</title>
<style>
body { margin:0; background:#000; font-family:Arial }
.artplayer-app {
    width:100%;
    max-width:900px;
    height:506px;
    margin:40px auto;
    background:#000;
}
#status {
    text-align:center;
    color:#aaa;
    font-size:14px;
}
</style>
</head>

<body>

<div class="artplayer-app"></div>
<div id="status">Initializing…</div>

<script src="https://cdn.jsdelivr.net/npm/@swarmcloud/hls/hls.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/artplayer@5.0.9/dist/artplayer.js"></script>

<script>
(async () => {
    const statusEl = document.getElementById("status");

    const params = new URLSearchParams(location.search);
    const title =
        params.get("title") ||
        params.get("tittle") ||
        "wednesday.s02e05";

    statusEl.textContent = `Waiting 5 seconds… (${title})`;

    // ⏳ 5 second delay
    await new Promise(r => setTimeout(r, 5000));

    // ✅ Render API THROUGH proxy
    const renderApi =
        "https://workingg.vercel.app/api/proxy?url=" +
        encodeURIComponent(
            "https://u-1-1azw.onrender.com/api/get-stream?title=" + title
        );

    statusEl.textContent = "Fetching stream info…";

    let data;
    try {
        const res = await fetch(renderApi);
        data = await res.json();
    } catch (e) {
        statusEl.textContent = "Render API blocked or offline";
        console.error(e);
        return;
    }

    if (!data?.m3u8_url) {
        statusEl.textContent = "Stream not found";
        return;
    }

    // ✅ Wrap final m3u8 with proxy
    const finalUrl =
        "https://workingg.vercel.app/api/proxy?url=" +
        encodeURIComponent(data.m3u8_url);

    statusEl.textContent = "Starting player…";

    new Artplayer({
        container: ".artplayer-app",
        url: finalUrl,
        type: "m3u8",
        autoplay: true,
        playsInline: true,
        theme: "#e50914",
        fullscreen: true,
        fullscreenWeb: true,
        pip: true,
        setting: true,
        customType: {
            m3u8(video, url) {
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(url);
                    hls.attachMedia(video);
                } else {
                    video.src = url;
                }
            }
        }
    });

    statusEl.textContent = `Playing: ${title}`;
})();
</script>

</body>
</html>
