<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ArtPlayer Stream</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ✅ ArtPlayer CSS (CORRECT PATH) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/artplayer@5.1.2/artplayer.css">

<style>
html, body {
    margin: 0;
    padding: 0;
    background: #000;
    width: 100%;
    height: 100%;
}

#player {
    width: 100%;
    height: 100%;
    background: #000;
}

/* Netflix-like spinner */
.spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 60px;
    height: 60px;
    margin: -30px;
    border: 4px solid rgba(255,255,255,0.2);
    border-top: 4px solid #e50914;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    z-index: 9;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>
</head>
<body>

<div id="player">
    <div class="spinner" id="spinner"></div>
</div>

<!-- ✅ Libraries -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.17/dist/hls.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/artplayer@5.1.2/artplayer.js"></script>

<script>
/* ==========================
   CONFIG
========================== */
const RENDER_API = "https://u-1-1azw.onrender.com/api/get-stream?title=";
const PROXY = "https://workingg.vercel.app/api/proxy?url=";
const SUB_API = "https://sub.wyzie.ru/search";

/* ==========================
   SLUG PARSER (FIXED)
========================== */
const params = new URLSearchParams(location.search);

const TITLE   = params.get("title");   // wednesday.s02e05
const IMDB    = params.get("id");      // tt4574334
const SEASON  = params.get("season");  // 1
const EPISODE = params.get("episode"); // 1

if (!TITLE) {
    alert("Missing ?title=");
    throw new Error("Missing title");
}

/* ==========================
   HELPERS
========================== */
function proxy(url) {
    return PROXY + encodeURIComponent(url);
}

function hideSpinner() {
    document.getElementById("spinner").style.display = "none";
}

/* ==========================
   FETCH STREAM (RENDER)
========================== */
async function fetchStream() {
    const res = await fetch(proxy(RENDER_API + encodeURIComponent(TITLE)));
    const json = await res.json();

    if (!json || !json.m3u8_url) {
        throw new Error("No m3u8 in response");
    }

    return {
        url: proxy(json.m3u8_url),
        headers: json.headers || {}
    };
}

/* ==========================
   FETCH SUBTITLES
========================== */
async function fetchSubtitles() {
    if (!IMDB) return [];

    let url = `${SUB_API}?id=${IMDB}`;
    if (SEASON && EPISODE) {
        url += `&season=${SEASON}&episode=${EPISODE}`;
    }

    const res = await fetch(proxy(url));
    const data = await res.json();

    if (!Array.isArray(data)) return [];

    return data.map(s => ({
        html: s.lang,
        url: proxy(s.url),
        type: "vtt"
    }));
}

/* ==========================
   INIT PLAYER
========================== */
(async function init() {
    try {
        const stream = await fetchStream();
        const subtitles = await fetchSubtitles();

        const art = new Artplayer({
            container: "#player",
            autoplay: true,
            autoSize: true,
            fullscreen: true,
            setting: true,
            pip: true,
            playbackRate: true,
            aspectRatio: true,
            hotkey: true,
            volume: 0.8,
            mutex: true,
            backdrop: true,
            screenshot: true,
            airplay: true,
            autoOrientation: true,

            customType: {
                m3u8: function (video, url) {
                    if (Hls.isSupported()) {
                        const hls = new Hls({
                            enableWorker: true,
                            lowLatencyMode: false,
                            backBufferLength: 90
                        });

                        hls.loadSource(url);
                        hls.attachMedia(video);

                        hls.on(Hls.Events.MANIFEST_PARSED, hideSpinner);
                    } else {
                        video.src = url;
                    }
                }
            },

            url: stream.url,
            type: "m3u8",

            subtitles: {
                style: {
                    color: "#fff",
                    fontSize: "18px",
                    textShadow: "0 0 5px #000"
                },
                cues: [],
            },

            controls: [
                {
                    position: "center",
                    html: `<img src="https://rivestream.org/images/player/backward.svg" width="60">`,
                    click: () => art.backward = 10,
                },
                {
                    position: "center",
                    html: `<img src="https://rivestream.org/images/player/play.svg" width="70">`,
                    click: () => art.toggle(),
                },
                {
                    position: "center",
                    html: `<img src="https://rivestream.org/images/player/forward.svg" width="60">`,
                    click: () => art.forward = 10,
                },
            ],
        });

        /* ==========================
           SUBTITLE SETTINGS
        ========================== */
        if (subtitles.length) {
            art.setting.add({
                name: "Subtitles",
                html: "Select",
                selector: subtitles.map((s, i) => ({
                    html: s.html,
                    value: i
                })),
                onSelect: item => {
                    art.subtitle.switch(subtitles[item.value].url);
                    return item.html;
                }
            });
        }

    } catch (e) {
        console.error(e);
        alert("Failed to load stream");
    }
})();
</script>

</body>
</html>
