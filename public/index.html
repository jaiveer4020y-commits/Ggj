<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ArtPlayer Full</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ✅ ARTPLAYER CSS (UNPKG – WORKS ON VERCEL) -->
<link rel="stylesheet" href="https://unpkg.com/artplayer@5.1.2/dist/artplayer.css">

<style>
html, body {
    margin: 0;
    padding: 0;
    background: black;
    width: 100%;
    height: 100%;
}
#player {
    width: 100%;
    height: 100%;
    background: black;
    position: relative;
}
.spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 64px;
    height: 64px;
    margin: -32px;
    border: 4px solid rgba(255,255,255,.2);
    border-top-color: #e50914;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    z-index: 99;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>

<body>
<div id="player">
    <div class="spinner" id="spinner"></div>
</div>

<!-- ✅ LIBRARIES (PINNED & SAFE) -->
<script src="https://unpkg.com/hls.js@1.5.17/dist/hls.min.js"></script>
<script src="https://unpkg.com/artplayer@5.1.2/dist/artplayer.js"></script>

<script>
/* ======================================================
   CONFIG
====================================================== */
const PROXY = "https://workingg.vercel.app/api/proxy?url=";
const STREAM_API = "https://u-1-1azw.onrender.com/api/get-stream?title=";
const SUB_API = "https://sub.wyzie.ru/search";

/* ======================================================
   SLUG DETECTION (FIXED)
====================================================== */
const qs = new URLSearchParams(location.search);

const TITLE   = qs.get("title");    // wednesday.s01e02
const IMDB    = qs.get("id");       // tt4574334
const SEASON  = qs.get("season");   // 1
const EPISODE = qs.get("episode");  // 2

if (!TITLE) {
    alert("Missing ?title=");
    throw new Error("Missing title");
}

/* ======================================================
   HELPERS
====================================================== */
const proxy = url => PROXY + encodeURIComponent(url);
const hideSpinner = () =>
    document.getElementById("spinner").style.display = "none";

/* ======================================================
   FETCH STREAM
====================================================== */
async function getStream() {
    const r = await fetch(proxy(STREAM_API + TITLE));
    const j = await r.json();

    if (!j || !j.m3u8_url) throw "NO STREAM";

    return {
        url: proxy(j.m3u8_url),
        headers: j.headers || {}
    };
}

/* ======================================================
   FETCH SUBTITLES
====================================================== */
async function getSubtitles() {
    if (!IMDB) return [];

    let url = `${SUB_API}?id=${IMDB}`;
    if (SEASON && EPISODE) {
        url += `&season=${SEASON}&episode=${EPISODE}`;
    }

    const r = await fetch(proxy(url));
    const subs = await r.json();

    if (!Array.isArray(subs)) return [];

    return subs.map(s => ({
        html: s.lang,
        url: proxy(s.url),
        type: "vtt"
    }));
}

/* ======================================================
   INIT PLAYER
====================================================== */
(async () => {
    try {
        const stream = await getStream();
        const subtitles = await getSubtitles();

        const art = new Artplayer({
            container: "#player",
            url: stream.url,
            type: "m3u8",
            autoplay: true,
            setting: true,
            fullscreen: true,
            hotkey: true,
            pip: true,
            playbackRate: true,
            aspectRatio: true,
            volume: 0.8,
            mutex: true,
            autoOrientation: true,

            customType: {
                m3u8(video, url) {
                    if (Hls.isSupported()) {
                        const hls = new Hls({
                            enableWorker: true,
                            backBufferLength: 90
                        });
                        hls.loadSource(url);
                        hls.attachMedia(video);
                        hls.on(Hls.Events.MANIFEST_PARSED, hideSpinner);
                    } else {
                        video.src = url;
                        hideSpinner();
                    }
                }
            },

            controls: [
                {
                    position: "center",
                    html: `<img src="https://rivestream.org/images/player/backward.svg" width="60">`,
                    click: () => art.currentTime -= 10
                },
                {
                    position: "center",
                    html: `<img src="https://rivestream.org/images/player/play.svg" width="70">`,
                    click: () => art.toggle()
                },
                {
                    position: "center",
                    html: `<img src="https://rivestream.org/images/player/forward.svg" width="60">`,
                    click: () => art.currentTime += 10
                }
            ]
        });

        /* ================= SUBTITLE SETTING ================= */
        if (subtitles.length) {
            art.setting.add({
                name: "Subtitles",
                html: "Select",
                selector: subtitles.map((s, i) => ({
                    html: s.html,
                    value: i
                })),
                onSelect(item) {
                    art.subtitle.switch(subtitles[item.value].url);
                    return item.html;
                }
            });
        }

    } catch (e) {
        console.error(e);
        alert("STREAM LOAD FAILED");
    }
})();
</script>
</body>
</html>
