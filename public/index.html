<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Netflix Style ArtPlayer</title>

<!-- âœ… REQUIRED CSS (DO NOT CHANGE) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/artplayer@5.1.2/dist/artplayer.css">

<style>
html, body {
    margin: 0;
    padding: 0;
    background: #000;
    height: 100%;
}

.artplayer-app {
    width: 100%;
    max-width: 960px;
    aspect-ratio: 16 / 9;
    margin: 40px auto;
    background: black;
}

/* Netflix spinner */
.netflix-spinner {
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    100% { transform: rotate(360deg); }
}

/* Center controls */
.netflix-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 120px;
    pointer-events: none;
}
.netflix-btn {
    pointer-events: auto;
    cursor: pointer;
}
.netflix-btn img {
    width: 64px;
    height: 64px;
    filter: drop-shadow(0 0 10px black);
}
.netflix-btn.play img {
    width: 96px;
    height: 96px;
}
</style>
</head>

<body>

<div class="artplayer-app"></div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.17/dist/hls.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/artplayer@5.1.2/dist/artplayer.js"></script>

<script>
/* -------------------------------
   URL PARAMS
-------------------------------- */
const params = new URLSearchParams(location.search);

const rawTitle = params.get("title");
const imdbId   = params.get("id");
const season   = params.get("season");
const episode  = params.get("episode");

if (!rawTitle) {
    document.body.innerHTML = "<h2 style='color:white;text-align:center'>Missing title</h2>";
    throw new Error("Missing title");
}

/* -------------------------------
   TITLE NORMALIZATION (CRITICAL)
-------------------------------- */
function normalizeTitle(t) {
    return t
        .toLowerCase()
        .replace(/\.s(\d+)e(\d+)/i, "-s$1e$2")
        .replace(/\./g, "-")
        .replace(/--+/g, "-")
        .trim();
}

const slug = normalizeTitle(rawTitle);

/* -------------------------------
   PROXY HELPERS
-------------------------------- */
const PROXY = "https://workingg.vercel.app/api/proxy?url=";
const RENDER_API = `https://u-1-1azw.onrender.com/api/get-stream?title=${slug}`;

async function fetchJSON(url) {
    const res = await fetch(PROXY + encodeURIComponent(url));
    if (!res.ok) throw new Error("Fetch failed");
    return res.json();
}

/* -------------------------------
   SUBTITLE SCRAPER
-------------------------------- */
async function fetchSubtitles() {
    if (!imdbId) return [];
    let url = `https://sub.wyzie.ru/search?id=${imdbId}`;
    if (season && episode) {
        url += `&season=${season}&episode=${episode}`;
    }
    return fetchJSON(url);
}

/* -------------------------------
   INIT PLAYER
-------------------------------- */
(async () => {
    const streamData = await fetchJSON(RENDER_API);
    if (!streamData?.m3u8_url) throw new Error("No m3u8");

    const art = new Artplayer({
        container: ".artplayer-app",
        url: PROXY + encodeURIComponent(streamData.m3u8_url),
        type: "m3u8",
        autoplay: false,
        setting: true,
        playbackRate: true,
        aspectRatio: true,
        fullscreen: true,
        fullscreenWeb: true,
        pip: true,
        airplay: true,
        mutex: true,
        theme: "#e50914",
        icons: {
            loading: `<img class="netflix-spinner" src="https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png">`
        },
        layers: [{
            html: `
            <div class="netflix-overlay">
                <div class="netflix-btn back"><img src="https://rivestream.org/images/player/backward.svg"></div>
                <div class="netflix-btn play"><img src="https://rivestream.org/images/player/play.svg"></div>
                <div class="netflix-btn forward"><img src="https://rivestream.org/images/player/forward.svg"></div>
            </div>`
        }],
        customType: {
            m3u8(video, url) {
                const hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: false
                });
                hls.loadSource(url);
                hls.attachMedia(video);

                /* QUALITY */
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    art.setting.add({
                        name: "quality",
                        html: "Quality",
                        selector: [
                            { html: "Auto", level: -1, default: true },
                            ...hls.levels.map((l, i) => ({
                                html: `${l.height}p`,
                                level: i
                            }))
                        ],
                        onSelect: item => {
                            hls.currentLevel = item.level;
                            return item.html;
                        }
                    });
                });

                /* AUDIO */
                hls.on(Hls.Events.AUDIO_TRACKS_UPDATED, (_, data) => {
                    if (data.audioTracks.length > 1) {
                        art.setting.add({
                            name: "audio",
                            html: "Audio",
                            selector: data.audioTracks.map((t, i) => ({
                                html: t.name || t.lang || `Track ${i}`,
                                index: i,
                                default: i === hls.audioTrack
                            })),
                            onSelect: item => {
                                hls.audioTrack = item.index;
                                return item.html;
                            }
                        });
                    }
                });

                art.hls = hls;
            }
        }
    });

    /* CENTER BUTTONS */
    const back = document.querySelector(".netflix-btn.back");
    const play = document.querySelector(".netflix-btn.play");
    const forward = document.querySelector(".netflix-btn.forward");

    back.onclick = () => art.seek = art.currentTime - 10;
    forward.onclick = () => art.seek = art.currentTime + 10;
    play.onclick = () => art.toggle();

    /* SUBTITLES */
    const subs = await fetchSubtitles();
    if (subs?.length) {
        art.setting.add({
            name: "subtitle",
            html: "Subtitles",
            selector: [
                { html: "Off", url: "", default: true },
                ...subs.map(s => ({
                    html: s.lang,
                    url: PROXY + encodeURIComponent(s.url)
                }))
            ],
            onSelect: item => {
                art.subtitle.url = item.url;
                return item.html;
            }
        });
    }
})();
</script>
</body>
</html>
