<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Advanced ArtPlayer Stream</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/artplayer@5.1.2/dist/artplayer.css">

<style>
/* =========================
   GLOBAL
========================= */
html, body {
    margin: 0;
    padding: 0;
    background: #000;
    width: 100%;
    height: 100%;
    overflow: hidden;
    font-family: Arial, Helvetica, sans-serif;
}

#app {
    width: 100%;
    height: 100%;
}

/* =========================
   NETFLIX LOADING SPINNER
========================= */
.art-loading {
    background: transparent !important;
}
.netflix-spinner {
    width: 64px;
    height: 64px;
    border: 6px solid rgba(255,255,255,.2);
    border-top-color: #e50914;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}

/* =========================
   CENTER CONTROLS
========================= */
.center-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 90px;
    pointer-events: none;
    z-index: 40;
}
.center-overlay img {
    width: 70px;
    height: 70px;
    pointer-events: auto;
    cursor: pointer;
    opacity: .9;
}
.center-overlay img.play {
    width: 90px;
    height: 90px;
}

/* =========================
   SUBTITLE STYLE
========================= */
.art-subtitle {
    font-size: 22px !important;
    color: #fff !important;
    text-shadow: 0 0 6px #000 !important;
    background: rgba(0,0,0,.4) !important;
    padding: 4px 10px !important;
    border-radius: 3px;
}
</style>
</head>

<body>
<div id="app"></div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.17/dist/hls.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/artplayer@5.1.2/dist/artplayer.js"></script>

<script>
/* =========================================================
   1️⃣ SLUG DETECTION (STRICT, SAFE)
========================================================= */
const params = new URLSearchParams(window.location.search);

const TITLE_RAW = params.get("title") || params.get("tittle") || "";
const TITLE = TITLE_RAW.trim().toLowerCase();

const IMDB_ID = params.get("id") || "";
const SEASON = params.get("season");
const EPISODE = params.get("episode");

if (!TITLE) {
    document.body.innerHTML =
        "<h2 style='color:white;text-align:center'>Missing ?title</h2>";
    throw new Error("TITLE missing");
}

/* =========================================================
   2️⃣ CONSTANTS (PROXY EVERYTHING)
========================================================= */
const PROXY = "https://workingg.vercel.app/api/proxy?url=";
const RENDER_API =
    "https://u-1-1azw.onrender.com/api/get-stream?title=" +
    encodeURIComponent(TITLE);

/* =========================================================
   3️⃣ FETCH STREAM VIA PROXY (IMPORTANT FIX)
========================================================= */
async function fetchStreamUrl() {
    const proxiedApi =
        PROXY + encodeURIComponent(RENDER_API);

    const res = await fetch(proxiedApi);
    if (!res.ok) throw new Error("Render API failed");

    const json = await res.json();
    if (!json.url) throw new Error("No m3u8 in response");

    return PROXY + encodeURIComponent(json.url);
}

/* =========================================================
   4️⃣ FETCH SUBTITLES VIA PROXY
========================================================= */
async function fetchSubtitles() {
    if (!IMDB_ID) return [];

    let subUrl = "https://sub.wyzie.ru/search?id=" + IMDB_ID;
    if (SEASON && EPISODE) {
        subUrl += "&season=" + SEASON + "&episode=" + EPISODE;
    }

    const res = await fetch(
        PROXY + encodeURIComponent(subUrl)
    );
    if (!res.ok) return [];

    const list = await res.json();
    if (!Array.isArray(list)) return [];

    return list.map((s, i) => ({
        html: s.lang || "Subtitle " + (i + 1),
        url: PROXY + encodeURIComponent(s.url),
        default: i === 0
    }));
}

/* =========================================================
   5️⃣ INIT PLAYER (NO CUT FEATURES)
========================================================= */
(async function init() {
    const streamUrl = await fetchStreamUrl();
    const subtitles = await fetchSubtitles();

    let hlsInstance;

    const art = new Artplayer({
        container: "#app",
        url: streamUrl,
        type: "m3u8",
        autoplay: true,
        muted: false,
        setting: true,
        fullscreen: true,
        pip: true,
        playbackRate: true,
        aspectRatio: true,
        screenshot: true,
        airplay: true,
        backdrop: true,
        customType: {
            m3u8(video, url) {
                if (Hls.isSupported()) {
                    hlsInstance = new Hls({
                        enableWorker: true,
                        backBufferLength: 90,
                        maxBufferLength: 60,
                        maxMaxBufferLength: 120
                    });
                    hlsInstance.loadSource(url);
                    hlsInstance.attachMedia(video);
                } else {
                    video.src = url;
                }
            }
        },
        subtitles: {
            style: {
                fontSize: "22px",
                color: "#fff",
                textShadow: "0 0 6px #000"
            },
            list: subtitles
        },
        icons: {
            loading: `<div class="netflix-spinner"></div>`
        },
        layers: [{
            html: `
                <div class="center-overlay">
                    <img src="https://rivestream.org/images/player/backward.svg" id="rew">
                    <img src="https://rivestream.org/images/player/play.svg" class="play" id="play">
                    <img src="https://rivestream.org/images/player/forward.svg" id="fwd">
                </div>
            `
        }]
    });

    /* =====================================================
       CENTER CONTROLS
    ===================================================== */
    art.on("ready", () => {
        document.getElementById("rew").onclick =
            () => art.seek = art.currentTime - 10;
        document.getElementById("fwd").onclick =
            () => art.seek = art.currentTime + 10;
        document.getElementById("play").onclick =
            () => art.toggle();
    });

    /* =====================================================
       AUDIO & QUALITY (HLS → SETTINGS)
    ===================================================== */
    art.on("ready", () => {
        if (!hlsInstance) return;

        if (hlsInstance.audioTracks.length) {
            art.setting.add({
                name: "Audio",
                selector: hlsInstance.audioTracks.map((t, i) => ({
                    html: t.name || "Track " + i,
                    value: i
                })),
                onSelect(item) {
                    hlsInstance.audioTrack = item.value;
                    return item.html;
                }
            });
        }

        if (hlsInstance.levels.length) {
            art.setting.add({
                name: "Quality",
                selector: [
                    { html: "Auto", value: -1 },
                    ...hlsInstance.levels.map((l, i) => ({
                        html: l.height + "p",
                        value: i
                    }))
                ],
                onSelect(item) {
                    hlsInstance.currentLevel = item.value;
                    return item.html;
                }
            });
        }
    });
})();
</script>
</body>
</html>
